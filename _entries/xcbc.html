---
title: Building xCBC
subtitle: a Discord to CBC tool
description: "Fixing the Meta Problem from the outside"
publishedOn: 2022-07-07
category: programming
tags: 
  - cbc
  - discord
  - nodejs
  - docker
  - traefik
length: "6 minutes"
---
<section>
	<p>For a while now, when linking to a CBC post on Discord, instead of generating a link preview using the Open Graph or Twitter meta tags, the link remains an undescriptive string that may hestiate to click on do to concerns around the trustworthiness and value of it.</p>
	<p>This, of course, leads to issues when you are in a community that likes to share news sources, if every other source has the preview, then CBC will be last choice to share.</p>
</section>
<section>
	<div id="table-of-contents">
		<nav>
			<div>Table of Contents</div>
			<ul>
				<li><a href="#problem">The Problem</a></li>
				<ul>
					<li><a href="#lightbulb">The Lightbulb Moment</a></li>
				</ul>
				<li><a href="#solution">The Solutiion</a></li>
				<li><a href="#plan">The Plan</a></li>
				<ul>
					<li><a href="#domain">The Domain (and Project Name)</a></li>
				</ul>
				<li><a href="#first">The First Attempt</a></li>
				<li><a href="#second">The Second Attempt</a></li>
				<li><a href="#wrapup">The Wrap-Up</a></li>
			</ul>
		</nav>
	</div>
</section>
<section>
	<h3 id="problem">The Problem</h3>
	<p>On July 7th, 2021, the last known link preview generated by Discord from the CBC website appeared, after that any attempts to post a link to the website directly met with a roadblock.</p>
	{%include figure.html type="image" source="/media/xcbc/link-preview-fail.png" caption="Ignore the timestamp, I totally have a sleep schedule." %}
	<p>Since the issue was self-concealing, I didn't really notice it until early 2022. In May I decided to do some testing to see if the problem was on Discord's end or CBC's end. Deciding to make a copy of an article's relevant meta tags and using them on an alternative domain.</p>
	{%include figure.html type="image" source="/media/xcbc/link-preview-success.png" caption="" %}
	<p>That worked fine, so the issue wasn't that the tags were incorrect, Discord would render it just fine, which was really annoying becuase if that was the problem the solution would be <i>really easy</i>.</p>
	<p>So unfortunately, it seemed something was just failing somewhere in the engima of a process Discord uses to generate previews, or maybe, it was intentional? <i>Dun dun dun...</i></p>
	<aside><p>Note: appropo of nothing, but anyone here know <a href="https://en.wikipedia.org/wiki/Hanlon%27s_razor" class="off">Hanlon's Razor</a>.</p></aside>
	<p>With this in mind, I tried some of the other CBC domains, I found that <code>cbc.ca</code>, <code>www.cbc.ca</code>, <code>gem.cbc.ca</code>, andd <code>cbc.radio-canada.ca</code> all failed to have a link preview but <code>ici.radio-canada.ca</code> succeed.</p>
	<p>Unable to think of anything more to test, I emailed my findings to CBC, after which we commiserated over the unknown solution and the probablity that the issue was on Discord's end.</p>
	<h4 id="lightbulb">The Lightbulb Moment</h4>
	<p>So a month later, while tinkering with some projects, an idea popped in my head. What if Discord wasn't the root of all evil?</p>
	<p>Wanting to test a theory, I used Node.js and Ngrok to get Discord's User-Agent: <code>Mozilla/5.0 (compatible; Discordbot/2.0; +https://discordapp.com)</code>, then I used it when visiting <code>cbc.ca</code> and well...</p>
	{% include figure.html type="image" source="/media/xcbc/access-denied.png" caption="" %}
	<p>It seems the issue wasn't on Discord's side after all! On both <code>cbc.ca</code> and <code>www.cbc.ca</code>, we get this response. This doesn't explain the issues on <code>gem.cbc.ca</code> or <code>cbc.radio-canada.ca</code> but it turns out those both are more easily explainable: invalid meta tags!</p>
	<aside><p>I wonder why it Twitter made it through the whitelist but not Discord?</p></aside>
	<p>Gem seems to just be missing the required tags entirely while Radio Canada seems to initial load the page with empty meta tags to be filled as the page further loads, which just doesn't work when services are scraping the basic page for the tags.</p>
	<p>Armed with slightly more useful knowledge than before, I sent off further information on June 12th explaining what I found to CBC, in hopes they'd solve it.</p>
	<p>As of July 7th, I have yet to hear back.</p>
</section>
<section>
	<h3 id="solution">The Solution</h3>
	<p>So now, what can be done about the issue? I don't know if my email to the CBC got thrown in the void or just ignored. A real solution would come from them but who knows when or if that will happen?</p>
	<p>But that's quitter talk, I know the pros and the cons of gramming, I can take a shot at some sort of solution.</p>
	<p>So I present: xCBC!</p>
</section>
<section>
	<h3 id="plan">The Plan</h3>
	<p>I am far from the first person to create a service meant to enhance another site, nor am I the first to think of extending a domain for ease of use of the service. In this case the idea is to have users prepend a character (<code>x</code>) to the regular CBC domain when posting a link to an article on Discord, at which point Discord will ask xCBC for it's meta tags that it will pull either from cache or from CBC using a whitelisted User Agent.</p>
	<p>Then, if a user clicks through the link, xCBC will redirect the user to CBC article for proper viewing. Simple!</p>
	{% include figure.html type="image" source="/media/xcbc/the-plan.png" caption="I'm sure this clears things up. /s" %}
	<h4 id="domain">The Domain (and Project Name)</h4>
	<p>The first thing to do in such a project, is of course name it. I needed it to be [something]CBC since the branding of it needs to match the domain and the domain has to be a simple addition to <code>cbc.ca</code>.</p>
	<p>I decided to go with xCBC because it satisfied the conditions, was close to the Paste shortcut (on desktop), and most importantly the domain was available for registeration.</p>
	<aside><p>Get $6.46 off your first purchase with my <a href="https://www.name.com/referral/302312" class="off">Name.com referral</a>.</p></aside>
	</section>
	<section>
		<h3 id="first">The First Attempt</h3>
		<p>My inital thinking for the application is a simple catch-all <a href="https://www.fastify.io/" class="off">Fastify</a> server with a <a href="https://www.npmjs.com/package/better-sqlite3" class="off">Sqlite3</a> database as the cache and using Node v18's built-in <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" class="off">Fetch</a> to handle the fetching. The cache may be overkill since Discord also caches it's link previews, but one of my goals is to not over-query CBC's site, just in case.</p>
		<p>After a bunch of bug-testing, I realized that fiddling with Node's Fetch wasn't actually work it and instead switched to using <a href="https://github.com/sindresorhus/got" class="off">Got</a>, sure this was mainly due to my eyes glazing over when I thought about having to implement my own stream consumer but all those extra packages weren't going to install themselves!</p>
		<aside><p>Specifically I used Got v11, since I didn't want to have to deal with mixing CommonJS and ESM.</p></aside>
		<p>This version <i>did</i> technically work, testing it manually did show me the end results I was looking for. Unfortunately, the time it was taking to fetch the page from CBC, parse it, cache it, then send it off was too long for Discord to stick around for (around 4 seconds).</p>
		{% capture caption %}Discord's reaction to my work so far.<br />Photo by <a href="https://www.pexels.com/@karolina-grabowska/" class="off">Karolina Grabowska</a></p>{% endcapture %}	
		{% include figure.html type="image" source="/media/xcbc/discord-denied.jpg" caption=caption %}
		<p>So there was nothing to do but to refactor and see what I could do to deal with the slow-down.</p>
	</section>
	<section>
		<h3 id="second">The Second Attempt</h3>
		<p>So after the learning experience of the first attempt, I think the second attempt actually went very well. There's really only a couple of things I changed.</p>
		<h4>Starting the Reply Earlier</h4>
		<p>By switch from using Fastify's builtin <code>reply.send()</code> to <code>reply.raw</code>, I was able to send the first part of the page before fetching from CBC, making it so Discord wouldn't cancel out of the request so quickly. It was still taking more time than I would have liked to fetch but I don't think there is much I can do about that.</p>
		<h4>Ditching the Cache</h4>
		<p>Well, not entirely. As I was reading through Got's documentation I found out that it actually has a built-in caching mechanism, which was great as that meant I could pitch my attempt at one and really streamline the flow of the app. Now instead of having to do the freshness logic myself, I just needed to fetch.</p>
		<p>With only these changes, I had it working as intended and my bespoke logic down to about the same length as my parameter checking. It's honestly a bit funny how little of my own code there is in this. I could in the future Remove some dependencies (I am basically using the built-in <code>HTTP.ServerResponse</code> object, and I am sure I could learn to use Fetch. That's a problem for future me.</p>
		<aside><p>From experience, a lot of problems end up in future me's todo list.</p></aside>
	</section>
	<section>
		<h3 id="wrapup">The Wrap-Up</h3>
		<p>All that was left to do was to build the docker image, set it up behind a reverse-proxy (Traefik, of course), and set up a small <a href="https://xcbc.ca" class="off">landing page</a> for those curious enough.</p>
		<p>I don't know what the future holds for this, it may or may not get used. Maybe nobody will care, but I'll be happy enough knowing that I put my effort towards providing solutions.</p>
	</section>
</section>
